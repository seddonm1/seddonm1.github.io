<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content=True><meta name=MobileOptimized content=320><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content=no-referrer><link href="https://fonts.googleapis.com/css?family=Open+Sans:400|Old+Standard+TT:400" rel=stylesheet type=text/css><link rel=icon type=image/png href=https://reorchestrate.com/favicon_16x16.png sizes=16x16><link rel=icon type=image/png href=https://reorchestrate.com/favicon_32x32.png sizes=32x32><link rel=icon type=image/png href=https://reorchestrate.com/favicon_128x128.png sizes=128x128><title>SQLite Transactions</title><link rel=canonical href=https://reorchestrate.com/posts/sqlite-transactions/><style>*{border:0;font:inherit;font-size:100%;vertical-align:baseline;margin:0;padding:0;color:#000;text-decoration-skip:ink}body{font-family:open sans,myriad pro,Myriad,sans-serif;font-size:17px;-webkit-font-smoothing:antialiased;line-height:160%;color:#1d1313;max-width:950px;margin:auto}p{margin:20px 0}a img{border:none}img{margin:10px auto;max-width:100%;display:block}.left-justify{float:left}.right-justify{float:right}pre,code{font:12px Consolas,liberation mono,Menlo,Courier,monospace;background-color:#f7f7f7}code{font-size:12px;padding:4px}pre{margin-top:0;margin-bottom:16px;word-wrap:normal;padding:16px;overflow:auto;font-size:85%;line-height:1.45}pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:0 0;border:0}pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:#0000;border:0}pre code::before,pre code::after{content:normal}em,q,em,dfn{font-style:italic}.sans,html .gist .gist-file .gist-meta{font-family:open sans,myriad pro,Myriad,sans-serif}.mono,pre,code,tt,p code,li code{font-family:Menlo,Monaco,andale mono,lucida console,courier new,monospace}.heading,.serif,h1,h2,h3,h4,h5{font-family:old standard tt,serif}strong{font-weight:600}table{width:100%}thead{font-weight:800;background:#dadada}tbody tr:nth-child(even){background:#f7f7f7}table td,th{padding:2px}q:before{content:"\201C"}q:after{content:"\201D"}del,s{text-decoration:line-through}blockquote{font-family:old standard tt,serif;text-align:center;padding:50px}blockquote p{display:inline-block;font-style:italic}blockquote:before,blockquote:after{font-family:old standard tt,serif;content:'\201C';font-size:35px;color:#403c3b}blockquote:after{content:'\201D'}hr{width:40%;height:1px;background:#403c3b;margin:25px auto}h1{font-weight:700;font-size:35px}h2{font-weight:700;font-size:28px}h3{font-weight:700;font-size:22px;margin-top:28px}h4{font-weight:700;font-size:20px;margin-top:20px}h5{font-size:18px;margin-top:18px}h1 a,h2 a,h3 a,h4 a,h5 a{text-decoration:none}h1,h2{margin-top:28px}#sub-header,time{color:#403c3b;font-size:13px}#sub-header{margin:0 4px}#nav h1 a{font-size:35px;color:#1d1313;line-height:120%}.posts_listing a,#nav a{text-decoration:none}li{margin-left:20px}ul li{margin-left:5px}ul li{list-style-type:none}ul li:before{content:"\00BB \0020"}#nav ul li:before,.posts_listing li:before{content:'';margin-right:0}#content{text-align:left;width:100%;font-size:15px;padding:60px 0 80px}#content h1,#content h2{margin-bottom:5px}#content h2{font-size:25px}#content .entry-content{margin-top:15px}#content time{margin-left:3px}#content h1{font-size:30px}.highlight{margin:10px 0}.posts_listing{margin:0 0 50px}.posts_listing li{margin:0 0 25px 15px}.posts_listing li a:hover,#nav a:hover{text-decoration:underline}#nav{text-align:center;position:static;margin-top:60px}#nav ul{display:table;margin:8px auto 0}#nav li{list-style-type:none;display:table-cell;font-size:15px;padding:0 20px}#source{margin:50px 0 0}#links{margin:50px 0 0}#links :nth-child(2){float:right}#not-found{text-align:center}#not-found a{font-family:old standard tt,serif;font-size:200px;text-decoration:none;display:inline-block;padding-top:225px}#nav .sub{font-size:80%;display:inline-block;vertical-align:middle}#nav .sub p{color:#403c3b;margin:0}#nav .sub a{text-decoration:none}#nav .sub svg{fill:#403c3b;display:inline-block;vertical-align:middle;padding-bottom:3px;padding-right:5px}@media(max-width:750px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:28px}#nav li{font-size:13px;padding:0 15px}#content{margin-top:0;padding-top:50px;font-size:14px}#content h1{font-size:25px}#content h2{font-size:22px}.posts_listing li div{font-size:12px}}@media(max-width:400px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:22px}#nav li{font-size:12px;padding:0 10px}#content{margin-top:0;padding-top:20px;font-size:12px}#content h1{font-size:20px}#content h2{font-size:18px}.posts_listing li div{font-size:12px}}.chroma{background-color:#f0f0f0}.chroma .lntd{vertical-align:top;padding:0;margin:0;border:0}.chroma .lntable{border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block}.chroma .hl{display:block;width:100%;background-color:#ffc}.chroma .lnt{margin-right:.4em;padding:0 .4em}.chroma .ln{margin-right:.4em;padding:0 .4em}.chroma .k{color:#007020;font-weight:700}.chroma .kc{color:#007020;font-weight:700}.chroma .kd{color:#007020;font-weight:700}.chroma .kn{color:#007020;font-weight:700}.chroma .kp{color:#007020}.chroma .kr{color:#007020;font-weight:700}.chroma .kt{color:#902000}.chroma .na{color:#4070a0}.chroma .nb{color:#007020}.chroma .nc{color:#0e84b5;font-weight:700}.chroma .no{color:#60add5}.chroma .nd{color:#555;font-weight:700}.chroma .ni{color:#d55537;font-weight:700}.chroma .ne{color:#007020}.chroma .nf{color:#06287e}.chroma .nl{color:#002070;font-weight:700}.chroma .nn{color:#0e84b5;font-weight:700}.chroma .nt{color:#062873;font-weight:700}.chroma .nv{color:#bb60d5}.chroma .s{color:#4070a0}.chroma .sa{color:#4070a0}.chroma .sb{color:#4070a0}.chroma .sc{color:#4070a0}.chroma .dl{color:#4070a0}.chroma .sd{color:#4070a0;font-style:italic}.chroma .s2{color:#4070a0}.chroma .se{color:#4070a0;font-weight:700}.chroma .sh{color:#4070a0}.chroma .si{color:#70a0d0;font-style:italic}.chroma .sx{color:#c65d09}.chroma .sr{color:#235388}.chroma .s1{color:#4070a0}.chroma .ss{color:#517918}.chroma .m{color:#40a070}.chroma .mb{color:#40a070}.chroma .mf{color:#40a070}.chroma .mh{color:#40a070}.chroma .mi{color:#40a070}.chroma .il{color:#40a070}.chroma .mo{color:#40a070}.chroma .o{color:#666}.chroma .ow{color:#007020;font-weight:700}.chroma .c{color:#60a0b0;font-style:italic}.chroma .ch{color:#60a0b0;font-style:italic}.chroma .cm{color:#60a0b0;font-style:italic}.chroma .c1{color:#60a0b0;font-style:italic}.chroma .cs{color:#60a0b0;background-color:#fff0f0}.chroma .cp{color:#007020}.chroma .cpf{color:#007020}.chroma .gd{color:#a00000}.chroma .ge{font-style:italic}.chroma .gr{color:red}.chroma .gh{color:navy;font-weight:700}.chroma .gi{color:#00a000}.chroma .go{color:#888}.chroma .gp{color:#c65d09;font-weight:700}.chroma .gs{font-weight:700}.chroma .gu{color:purple;font-weight:700}.chroma .gt{color:#04d}.chroma .w{color:#bbb}</style></head><body><section id=nav><h1><a href=https://reorchestrate.com/>reorchestrate</a></h1><section class=section><div class=sub><p>&copy; Mike Seddon 2024 |
<a href=https://www.github.com/seddonm1 target=_blank><svg width="22" height="22" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M896 128q209 0 385.5 103T1561 510.5 1664 896q0 251-146.5 451.5T1139 1625q-27 5-40-7t-13-30q0-3 .5-76.5t.5-134.5q0-97-52-142 57-6 102.5-18t94-39 81-66.5 53-105T1386 856q0-119-79-206 37-91-8-204-28-9-81 11t-92 44l-38 24q-93-26-192-26t-192 26q-16-11-42.5-27T578 459.5 493 446q-45 113-8 204-79 87-79 206 0 85 20.5 150t52.5 105 80.5 67 94 39 102.5 18q-39 36-49 103-21 10-45 15t-57 5-65.5-21.5T484 1274q-19-32-48.5-52t-49.5-24l-20-3q-21 0-29 4.5t-5 11.5 9 14 13 12l7 5q22 10 43.5 38t31.5 51l10 23q13 38 44 61.5t67 30 69.5 7 55.5-3.5l23-4q0 38 .5 88.5t.5 54.5q0 18-13 30t-40 7q-232-77-378.5-277.5T128 896q0-209 103-385.5T510.5 231 896 128zM419 1231q3-7-7-12-10-3-13 2-3 7 7 12 9 6 13-2zm31 34q7-5-2-16-10-9-16-3-7 5 2 16 10 10 16 3zm30 45q9-7 0-19-8-13-17-6-9 5 0 18t17 7zm42 42q8-8-4-19-12-12-20-3-9 8 4 19 12 12 20 3zm57 25q3-11-13-16-15-4-19 7t13 15q15 6 19-6zm63 5q0-13-17-11-16 0-16 11 0 13 17 11 16 0 16-11zm58-10q-2-11-18-9-16 3-14 15t18 8 14-14z"/></svg></a><a href=https://www.linkedin.com/in/mikeseddonau/ target=_blank><svg width="22" height="22" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M365 1414h231V720H365v694zm246-908q-1-52-36-86t-93-34-94.5 34-36.5 86q0 51 35.5 85.5T479 626h1q59 0 95-34.5t36-85.5zm585 908h231v-398q0-154-73-233t-193-79q-136 0-209 117h2V720H723q3 66 0 694h231v-388q0-38 7-56 15-35 45-59.5t74-24.5q116 0 116 157v371zm468-998v960q0 119-84.5 203.5T1376 1664H416q-119 0-203.5-84.5T128 1376V416q0-119 84.5-203.5T416 128h960q119 0 203.5 84.5T1664 416z"/></svg></a></p></div></section><ul></ul></section><section id=content><h1>SQLite Transactions</h1><div id=sub-header>16 July 2024</div><div class=entry-content><h2 id=what-is-sqlite>What is SQLite?</h2><p>In the past few years <a href=https://www.sqlite.org/>SQLite</a> (not SQL-light) has had a surge of popularity as people have come to realise its power as an in-process, highly reliable SQL database engine as a backend for server processes rather than its traditional role of client or edge applications. This change in stance for SQLite has happend despite the authors almost <a href=https://www.sqlite.org/whentouse.html#checklist_for_choosing_the_right_database_engine>actively discouraging</a> its use for this purpose.</p><p>I am interested in SQLite for the some key reasons:</p><ul><li>It is conceptually simple: Imagine a <a href=https://en.wikipedia.org/wiki/B-tree>B-tree</a> of rows/tuples partitioned by a table&rsquo;s primary key that has been <a href=https://www.sqlite.org/testing.html>exhaustively tested</a> to persist that data to disk reliably, then add a <a href=https://en.wikipedia.org/wiki/SQL>SQL</a> interaction layer.</li><li>Is able to have practical backup strategy via <a href=https://litestream.io/>Litestream</a> that will perform backups and continuous replication of the write-ahead-log to a remote location. The backups are then able to be automatically restored on startup with a <a href=https://litestream.io/reference/restore/>trivial command</a>. Does your business really need the 99.99% uptime offered by expensive cloud managed databases like <a href=https://aws.amazon.com/rds/aurora/>AWS</a>, <a href=https://azure.microsoft.com/en-us/products/azure-sql/>Azure</a> or <a href=https://cloud.google.com/sql/postgresql>Google</a>?</li><li>It can be run locally as I still like having a complete development environment able to be run offline.</li><li><a href=https://www.sqlite.org/inmemorydb.html>in-memory</a> via <code>file::memory:</code> allowing test code to easily start up and tear down an instance per test if required.</li></ul><h2 id=the-single-writer-limitation>The single-writer limitation</h2><p>The limitations of SQLite on servers has been <a href=https://www.sqlite.org/whentouse.html#situations_where_a_client_server_rdbms_may_work_better>well documented</a> by the SQLite authors and the best <a href=https://kerkour.com/sqlite-for-servers>server side configurations</a> disected, however the standout limitation is <em>high-volume websites</em> by which they mean <em>write-heavy websites</em>.</p><p>In <a href=https://www.sqlite.org/wal.html>Write-Ahead Logging</a> mode (required by Litestream) SQLite employs a single writer by <a href=https://www.sqlite.org/wal.html#concurrency>design</a> which allows at most one write transaction but many read-only transactions to run concurrently. This design places the bottleneck of a <em>high-volume write-heavy website</em> squarely on how to manage throughput on that single writer&hellip; and that brings us back to one of the core building-blocks of modern technology:</p><h2 id=acid>ACID</h2><p>If you have forgotten about the <a href=https://en.wikipedia.org/wiki/Atomicity_(database_systems)>Atomic</a>, <a href=https://en.wikipedia.org/wiki/Consistency_(database_systems)>Consistent</a>, <a href=https://en.wikipedia.org/wiki/Isolation_(database_systems)>Isolated</a>, <a href=https://en.wikipedia.org/wiki/Durability_(database_systems)>Durable</a> guarantees provided by <a href=https://jepsen.io/>most</a> modern databases then this is the time to go and <a href=https://en.wikipedia.org/wiki/ACID>refresh your knowledge</a>.</p><h3 id=sqlite>SQLite</h3><p>SQLite, <a href=https://sqlite.org/isolation.html>by default</a>, offers strict <code>SERIALIZABLE</code> <a href=https://en.wikipedia.org/wiki/Isolation_(database_systems)>Isolated</a> transactions which is the strongest isolation guarantee (unless certain conditions are met: <a href=https://sqlite.org/isolation.html>https://sqlite.org/isolation.html</a>). By employing a single-writer, SQLite is using a form of <a href=https://en.wikipedia.org/wiki/Concurrency_control#Categories>Pessimistic concurrencly control</a> that makes it easy to guarantee that the underlying data has not changed whilst the write-transaction is in progress.</p><h3 id=postgres>Postgres</h3><p>Postgres, on the other hand, actually differs from the <code>SERIALIZABLE</code> default defined in the <a href=https://en.wikipedia.org/wiki/ISO/IEC_9075>SQL Standard</a> and chooses the more relaxed <code>READ COMMITTED</code> (and this is despite having the much more complex <a href=https://en.wikipedia.org/wiki/Multiversion_concurrency_control>Multiversion concurrency control</a>). This reduction in strictness means that it is at risk of <a href=https://en.wikipedia.org/wiki/Isolation_(database_systems)#Non-repeatable_reads>non-repeatable reads</a> where, even within the same transaction, it is possible to retrieve different results by executing the same read-query multiple times if the values have been changed by another <code>COMMITTED</code> transaction in the background. By choosing this isolation level Postgres opens the risk of a transaction operating on stale data. This fact needs to be kept-in-mind by the developer - imagine what might be possible if performing financial transactions with stale balance data?</p><p>If set to <a href=https://www.postgresql.org/docs/current/transaction-iso.html#XACT-SERIALIZABLE>SERIALIZABLE</a> then Postgres uses an <a href=https://en.wikipedia.org/wiki/Optimistic_concurrency_control>optimistic-concurrency control</a> scheme where data accessed during the transaction is tracked and before-commit is verified not to have changed. Postgres does this based on either <code>finer-grain</code> locking (row level) or <code>course-grain</code> locking (<code>page</code> level) depending on the transaction so as to manage memory usage. This pattern is referred to as <code>optimistic</code> due to the fact it is expected that there will not be a conflict due to the underlying data having changed when the transaction is committed - which is less likely to change the more <code>fine-grained</code> the data monitored by the transaction is.</p><h3 id=foundationdb>FoundationDB</h3><p>Transactions are not just limited to <a href=https://en.wikipedia.org/wiki/Relational_database>Relational databases</a>. FoundationDB, in my view one of the finest open-source projects (that incidentally has used SQLite&rsquo;s storage code for many years), also employs <a href=https://en.wikipedia.org/wiki/Optimistic_concurrency_control>optimistic-concurrency control</a> to achieve <code>SERIALIZABLE</code> guarantees across a distributed key-value store. At the time when NoSQL came onto the scene, distributed NoSQL stores with ACID guarantees were not common and FoundationDB wrote the <a href=https://apple.github.io/foundationdb/transaction-manifesto.html>Transaction Manifesto</a> to highlight how greatly the developer can benefit from the ACID guarantees.</p><p>FoundationDB goes one-step further and offers advice on how to write code for <a href=https://en.wikipedia.org/wiki/Optimistic_concurrency_control>optimistic-concurrency control</a> and the fact that sometimes data <em>will</em> change in reponse to a concurrent transaction conflict and the transaction is automatically retried:</p><h2 id=idempotence>Idempotence</h2><blockquote><p>An idempotent transaction is one that has the same effect when committed twice as when committed once. &ndash; FoundationDB</p></blockquote><p>In <a href=https://apple.github.io/foundationdb/developer-guide.html#developer-guide-unknown-results>making any transaction idempotent</a> FoundationDB provides patterns for how to avoid issues if a transaction needs to retried multiple times due to a conflict. Things like avoiding creating random identifiers inside the transaction might be immediately recognisable to <a href=https://en.wikipedia.org/wiki/Pure_function>functional programmers</a> but logic to guard against a state that may have changed since the intial execution may not be immediately obvious:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=c1># Increases account balance and stores a record of the deposit with a unique depositId</span>
<span class=nd>@fdb.transactional</span>
<span class=k>def</span> <span class=nf>deposit</span><span class=p>(</span><span class=n>tr</span><span class=p>,</span> <span class=n>acctId</span><span class=p>,</span> <span class=n>depositId</span><span class=p>,</span> <span class=n>amount</span><span class=p>):</span>

    <span class=c1># If the deposit record exists, the deposit already succeeded, and we can quit</span>
    <span class=n>depositKey</span> <span class=o>=</span> <span class=n>fdb</span><span class=o>.</span><span class=nb>tuple</span><span class=o>.</span><span class=n>pack</span><span class=p>((</span><span class=s1>&#39;account&#39;</span><span class=p>,</span> <span class=n>acctId</span><span class=p>,</span> <span class=n>depositId</span><span class=p>))</span>
    <span class=k>if</span> <span class=n>tr</span><span class=p>[</span><span class=n>depositKey</span><span class=p>]</span><span class=o>.</span><span class=n>present</span><span class=p>():</span> <span class=k>return</span>

    <span class=n>amount</span> <span class=o>=</span> <span class=n>struct</span><span class=o>.</span><span class=n>pack</span><span class=p>(</span><span class=s1>&#39;&lt;i&#39;</span><span class=p>,</span> <span class=n>amount</span><span class=p>)</span>
    <span class=n>tr</span><span class=p>[</span><span class=n>depositKey</span><span class=p>]</span> <span class=o>=</span> <span class=n>amount</span>

    <span class=c1># The above check ensures that the balance update is executed only once</span>
    <span class=n>balanceKey</span> <span class=o>=</span> <span class=n>fdb</span><span class=o>.</span><span class=nb>tuple</span><span class=o>.</span><span class=n>pack</span><span class=p>((</span><span class=s1>&#39;account&#39;</span><span class=p>,</span> <span class=n>acctId</span><span class=p>))</span>
    <span class=n>tr</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>balanceKey</span><span class=p>,</span> <span class=n>amount</span><span class=p>)</span></code></pre></div><p>With all that in our heads, what options does SQLite give us?</p><h2 id=begin>BEGIN &hellip;</h2><p>SQLite offers multiple ways for developers to indicate to the engine how the transaction will behave in the form of the <code>IMMEDIATE</code>, <code>EXCLUSIVE</code> and <code>DEFERRED</code> keywords that when in <a href=https://www.sqlite.org/wal.html>Write-Ahead Logging</a> mode can be reduced to <code>DEFERRED</code> vs <code>IMMEDIATE</code>.</p><p>It is worth mentioning the <code>SQLITE_BUSY_TIMEOUT</code> parameter that is configurable milliseconds delay that a transaction can wait before returning <code>SQLITE_BUSY</code> as seen below:</p><h3 id=deferred>DEFERRED</h3><p>Deferred means that the transaction will be started in <code>READ</code> mode that can run concurrently with any existing read or write transactions and will only be upgraded to a blocking <code>READ-WRITE</code> transction if a query that modifies the database state is executed (like <code>INSERT</code>, <code>UPDATE</code> or <code>DELETE</code>). If at the time of upgrade the database is locked by another transaction (plus <code>SQLITE_BUSY_TIMEOUT</code>) then a <code>SQLITE_BUSY</code> error will be returned and it is up to the client to handle it (e.g. fail/retry).</p><h3 id=immediate>IMMEDIATE</h3><p>Immediate means that the transaction will be started immediately in <code>READ-WRITE</code> mode and, if a write transaction is already running, will immediately (plus <code>SQLITE_BUSY_TIMEOUT</code>) return <code>SQLITE_BUSY</code>. Once again, it is up to the client to decide how to handle.</p><h3 id=concurrent>CONCURRENT</h3><p>SQLite has an <a href=https://www.sqlite.org/cgi/src/doc/begin-concurrent/doc/begin_concurrent.md>experimental branch</a> that moves the transactions from <a href=https://en.wikipedia.org/wiki/Concurrency_control#Categories>Pessimistic</a> to limited <a href=https://en.wikipedia.org/wiki/Optimistic_concurrency_control>Optimistic</a> - limited in that the optimistic locking operates at a database <a href=https://en.wikipedia.org/wiki/Page_%28computer_memory%29>page</a> level (by default <code>4096</code> bytes) not row/tuple level.</p><p>In <code>CONCURRENT</code> mode, SQLite will allow multiple write transactions to be active at once but, before commit, will verify that none of the <code>pages</code> accessed while performing the transaction have changed since the transaction began. If no conflict occurs then the changes will be committed sequentially and strict <code>SERIALIZABLE</code> guarantees are achieved. If conflicts occur then SQLite will return a <code>SQLITE_BUSY</code> and the client can decide how to handle. Note that this state cannot be resolved by waiting so <code>SQLITE_BUSY_TIMEOUT</code> does not apply.</p><h3 id=hc-tree>HC-Tree</h3><p>Another experimental branch of SQLite is [HC-Tree] which is a work-in-progress that aims to provide optimistic row/tuple level locking. One interesting outcome is that they provide an excellent set of <a href=https://sqlite.org/hctree/doc/hctree/doc/hctree/threadtest.wiki>benchmarks</a> to demonstrate the performance benefits of such a design against the <code>BEGIN CONCURRENT</code> branch.</p><p>Why don&rsquo;t we take their benchmarking approach and run it against the standard options?</p><h2 id=benchmarking>Benchmarking</h2><h3 id=setup>Setup</h3><p>This script is set up to seed the database with <code>n</code> (default 1000000) rows which will create a database file of around 350MB.</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=n>PRAGMA</span> <span class=n>journal_mode</span> <span class=o>=</span> <span class=n>WAL</span><span class=p>;</span>
<span class=n>PRAGMA</span> <span class=n>mmap_size</span> <span class=o>=</span> <span class=mi>1000000000</span><span class=p>;</span>
<span class=n>PRAGMA</span> <span class=n>synchronous</span> <span class=o>=</span> <span class=k>off</span><span class=p>;</span>
<span class=n>PRAGMA</span> <span class=n>journal_size_limit</span> <span class=o>=</span> <span class=mi>16777216</span><span class=p>;</span>

<span class=k>CREATE</span> <span class=k>TABLE</span> <span class=n>tbl</span><span class=p>(</span>
    <span class=n>a</span> <span class=nb>INTEGER</span> <span class=k>PRIMARY</span> <span class=k>KEY</span><span class=p>,</span>
    <span class=n>b</span> <span class=nb>BLOB</span><span class=p>(</span><span class=mi>200</span><span class=p>),</span>
    <span class=k>c</span> <span class=nb>CHAR</span><span class=p>(</span><span class=mi>64</span><span class=p>)</span>
<span class=p>);</span>

<span class=c1>-- https://www.sqlite.org/series.html
</span><span class=c1></span><span class=k>WITH</span> <span class=k>RECURSIVE</span> <span class=n>generate_series</span><span class=p>(</span><span class=n>value</span><span class=p>)</span> <span class=k>AS</span> <span class=p>(</span>
    <span class=k>SELECT</span> <span class=mi>0</span>
    <span class=k>UNION</span> <span class=k>ALL</span>
    <span class=k>SELECT</span> <span class=n>value</span><span class=o>+</span><span class=mi>1</span> <span class=k>FROM</span> <span class=n>generate_series</span>
    <span class=k>WHERE</span> <span class=n>value</span> <span class=o>&lt;</span> <span class=err>{</span><span class=k>rows</span><span class=err>}</span>
<span class=p>)</span>
<span class=k>INSERT</span> <span class=k>INTO</span> <span class=n>tbl</span>
<span class=k>SELECT</span> <span class=n>value</span><span class=p>,</span> <span class=n>randomblob</span><span class=p>(</span><span class=mi>200</span><span class=p>),</span> <span class=n>hex</span><span class=p>(</span><span class=n>randomblob</span><span class=p>(</span><span class=mi>32</span><span class=p>))</span>
<span class=k>FROM</span> <span class=n>generate_series</span><span class=p>;</span>

<span class=k>CREATE</span> <span class=k>INDEX</span> <span class=n>tbl_i1</span> <span class=k>ON</span> <span class=n>tbl</span><span class=p>(</span><span class=n>substr</span><span class=p>(</span><span class=k>c</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>16</span><span class=p>));</span>
<span class=k>CREATE</span> <span class=k>INDEX</span> <span class=n>tbl_i2</span> <span class=k>ON</span> <span class=n>tbl</span><span class=p>(</span><span class=n>substr</span><span class=p>(</span><span class=k>c</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>16</span><span class=p>));</span></code></pre></div><h3 id=strategies>Strategies</h3><p>The <code>hc-tree</code> benchmarks run two queries: one random <code>SELECT</code> and one <code>UPDATE</code>.</p><p>The <code>SELECT</code> query performs a random index lookup using the <code>tbl_i1</code> index. <code>frandomblob</code> has been replaced with a variable so the transaction is idempotent.</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=c1>-- repeat nScan times:
</span><span class=c1>-- SELECT * FROM tbl WHERE substr(c, 1, 16)&gt;=hex(frandomblob(8)) ORDER BY substr(c, 1, 16) LIMIT 10;
</span><span class=c1></span><span class=k>SELECT</span> <span class=o>*</span> <span class=k>FROM</span> <span class=n>tbl</span> <span class=k>WHERE</span> <span class=n>substr</span><span class=p>(</span><span class=k>c</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span><span class=o>&gt;=?</span> <span class=k>ORDER</span> <span class=k>BY</span> <span class=n>substr</span><span class=p>(</span><span class=k>c</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span> <span class=k>LIMIT</span> <span class=mi>10</span><span class=p>;</span></code></pre></div><p>The <code>UPDATE</code> query refers to an <code>updateblob</code> function which can update a part of the <code>b</code> <code>BLOB</code>. As this does not exist the query has been changed to update the entire <code>b</code> and <code>c</code> values and to be idempotent.</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=c1>-- repeat nUpdate times:
</span><span class=c1>-- UPDATE tbl SET b=updateblob(b, ?, ?), c=hex(frandomblob(32)) WHERE a = ?;
</span><span class=c1></span><span class=k>UPDATE</span> <span class=n>tbl</span> <span class=k>SET</span> <span class=n>b</span><span class=o>=?</span><span class=p>,</span> <span class=k>c</span><span class=o>=?</span> <span class=k>WHERE</span> <span class=n>a</span><span class=o>=?</span><span class=p>;</span></code></pre></div><h3 id=behavior>Behavior</h3><p>The code has been written to start up <code>n</code> threads that will try to execute as many transactions as possible in a loop for 30 seconds (measured by incrementing a shared atomic counter).</p><ul><li>In all cases the code has been written to retry on <code>SQLITE_BUSY</code>.</li><li>Each transaction has been written to be idempotent so the <code>Scan</code> and <code>Update</code> parameters are generated outside of the retry loop to simulate how an automatic retry might operate.</li></ul><p>The final piece of setup is to control the file location to protect a solid-state-drive. This command on MacOS will create a *16*G ramdisk mounted at <code>/Volumes/ramdisk</code>. Calculated by RAM in MB (8192) * 2048.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>diskutil erasevolume apfs <span class=s1>&#39;ramdisk&#39;</span> <span class=sb>`</span>hdiutil attach -nobrowse -nomount ram://16777216<span class=sb>`</span></code></pre></div><p>Or Linux:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sudo mkdir -p /mnt/ramdisk
sudo mount -t tmpfs -o <span class=nv>size</span><span class=o>=</span>8g tmpfs /mnt/ramdisk</code></pre></div><h2 id=results>Results</h2><h3 id=nupdate-1-nscan-0>nUpdate=1, nScan=0</h3><p><img src=https://reorchestrate.com/img/2024/sqlite_n_update_1_n_scan_0.svg alt="Update 1 / Scan 0"></p><p>This write-only transaction shows:</p><ul><li><code>IMMEDIATE</code> vs <code>DEFERRED</code> benefits are clear as the locking happens immediately and the transaction does not suffer the upgrading cost.</li><li><code>CONCURRENT</code> does show increased throughput as the number of threads increases and conflicts increase. At the lower end it performs slightly worse indicating some level of bookkeeping cost. Even with only one update per transaction there were more than 1000 retried transactions at <code>16</code> threads.</li></ul><h3 id=nupdate-10-nscan-0>nUpdate=10, nScan=0</h3><p><img src=https://reorchestrate.com/img/2024/sqlite_n_update_10_n_scan_0.svg alt="Update 10 / Scan 0"></p><p>This write-only batched transaction shows:</p><ul><li>As expected, batching writes helps a lot with number of updated rows at <code>16</code> threads, <code>CONCURRENT</code> increasing from ~12k/sec to ~19k/sec.</li><li><code>IMMEDIATE</code> vs <code>DEFERRED</code> matters less as presumably the cost of doing the underlying update becomes more significant than the cost of upgrading the transaction (the upgrade only happens once per transaction vs the 10 updates).</li></ul><h3 id=nupdate-1-nscan-10>nUpdate=1, nScan=10</h3><p><img src=https://reorchestrate.com/img/2024/sqlite_n_update_1_n_scan_10.svg alt="Update 1 / Scan 10"></p><p>This transaction should should expose the weakness of the <code>page</code> level <code>CONCURRENT</code> locking as the random reads should increase collisions:</p><ul><li><code>IMMEDIATE</code>, <code>DEFERRED</code> and <code>CONCURRENT</code> all slowed around 5% vs <code>nUpdate=1, nScan=0</code> at <code>16</code> threads.</li><li>For <code>CONCURRENT</code> this is due to the fact that underlying collisions did not actually increase very much. See discussion below.</li></ul><h3 id=nupdate-10-nscan-10>nUpdate=10, nScan=10</h3><p><img src=https://reorchestrate.com/img/2024/sqlite_n_update_10_n_scan_10.svg alt="Update 10 / Scan 10"></p><p>This test does not show anything of significance compared with what we have already observed.</p><h3 id=nupdate-0-nscan-10>nUpdate=0, nScan=10</h3><p><img src=https://reorchestrate.com/img/2024/sqlite_n_update_0_n_scan_10.svg alt="Update 0 / Scan 10"></p><p>This read-only batched transaction shows:</p><ul><li><code>IMMEDIATE</code> vs <code>DEFERRED</code> shows the impact of <a href=https://en.wikipedia.org/wiki/Concurrency_control#Categories>Pessimistic concurrencly control</a> and why you should not default to <code>IMMEDIATE</code> for all transactions.</li><li><code>CONCURRENT</code> vs <code>DEFERRED</code> indicates there is not really a downside to using <code>CONCURRENT</code> mode as a default for all transactions as it performs the same or slightly better in all cases.</li></ul><h2 id=discussion>Discussion</h2><p>Some comments about <code>CONCURRENT</code>:</p><h3 id=write-ahead-logging>Write-ahead Logging</h3><p>To gain <a href=https://en.wikipedia.org/wiki/Optimistic_concurrency_control>optimistic-concurrency control</a> <code>CONCURRENT</code> makes heavy use of the <code>write-ahead-log</code> and if you watch the target directory while the <code>CONCURRENT</code> stage is running you will see the <code>-wal</code> suffixed file growing rapidly. This means you should be aware of a few things:</p><ul><li>These benchmarks were run against a temporary ram disk if the heavy writes of the <code>CONCURRENT</code> mode do need to be written to a storage then you can expect the write performance of your storage to become important and it is likely that <code>IMMMEDIATE</code> mode will be faster. So it is a good idea to benchmark against your actual device.</li><li>Sustained writes to the <code>write-ahead log</code> will not allow SQLite to execute <code>checkpointing</code> (copying the WAL data back into the main SQLite file and truncating the log) so the <code>WAL</code> will continue to grow until out of storage. SQLite maintains another <a href=https://sqlite.org/cgi/src/doc/wal2/doc/wal2.md>experimental branch</a> which uses two rotating <code>WAL</code> files to prevent this problem. The <a href="https://www.sqlite.org/src/timeline?r=bedrock">bedrock</a> branch incorporates <code>CONCURRENT</code> and <code>WAL2</code> patches however <a href=https://litestream.io/>Litestream</a> does not support <code>WAL2</code>.</li></ul><h3 id=collisions>Collisions</h3><p>This chart shows the number of retried transactions per second when executing with <code>nUpdate=10, nScan=10</code>.</p><p><img src=https://reorchestrate.com/img/2024/sqlite_n_update_10_n_scan_10_retries.svg alt="Update 10 / Scan 10"></p><ul><li>These tests perform updates over those ~80k pages so the probability of collision is low. If you reduce the number of rows in the table or change your sampling to something that is skewed like most recent records then the chance of collions goes up. See <a href=https://sqlite.org/src/doc/begin-concurrent/doc/begin_concurrent.md>this article</a> for programming notes which advises explicitly against using integer <code>ROWID</code> tables to try to reduce data locality issues.</li><li>Each row should be a maximum of 336 bytes made up of 8 bytes (<code>INTEGER</code> is variable-length encoded) + 200 bytes (<code>BLOB</code> raw encoding) + 128 bytes (<code>TEXT</code> is <code>UTF-8</code> encoded). This means that one <code>4096</code> byte page will have a maximum of <code>12</code> rows (before overhead). Based on this we expect ~80k pages are used to store the 1 million rows.</li><li>Interestingly, if the number of rows seeded is reduced to <code>1000</code> then the time to persist the data is so fast that collisions actually reduce despite the higher probability of a conflict.</li></ul><h2 id=run-it-yourself>Run it yourself</h2><p>Firstly, the absolute numbers here are not the purpose of this exercise. These should be used for relative performance only as you can run the benchmarks on your hardware to see what throughput you receive.</p><ul><li>A multi-platform Docker image is available at: <a href=https://github.com/users/seddonm1/packages/container/package/sqlite-bench>ghcr.io/seddonm1/sqlite-bench:0.1.0</a>.</li><li>This code has been pushed <a href=https://github.com/seddonm1/sqlite-bench>https://github.com/seddonm1/sqlite-bench</a>.</li><li>The excellent <a href=https://github.com/rusqlite/rusqlite>https://github.com/rusqlite/rusqlite</a> has been forked to make the minor changes required to build the SQLite <a href=https://www.sqlite.org/src/info/e3f8c70ef5a7349c>begin-concurrent</a> branch at version 3.46.0. To see the modifications see: <a href=https://github.com/rusqlite/rusqlite/compare/master...seddonm1:rusqlite:begin-concurrent>https://github.com/rusqlite/rusqlite/compare/master...seddonm1:rusqlite:begin-concurrent</a></li></ul><h2 id=futher-reading>Futher Reading</h2><ul><li><a href=https://fly.io/blog/all-in-on-sqlite-litestream/>https://fly.io/blog/all-in-on-sqlite-litestream/</a></li><li><a href=https://kerkour.com/sqlite-for-servers>https://kerkour.com/sqlite-for-servers</a></li><li><a href=https://simonwillison.net/2022/Oct/23/datasette-gunicorn/#benchmarking-sqlite>https://simonwillison.net/2022/Oct/23/datasette-gunicorn/#benchmarking-sqlite</a></li></ul></div><div id=source>If you find an error please raise a <a class="basic-alignment left" href=https://github.com/seddonm1/seddonm1.github.io/blob/main/content/posts/sqlite-transactions.md>pull request</a>.</div><div id=links><a class="basic-alignment left" href=https://reorchestrate.com/posts/custom-jwt-claims-with-ory-kratos/>&laquo; Custom JWT Claims with Ory Kratos</a></div></section></body></html>